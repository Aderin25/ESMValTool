###############################################################################
# recipe_OceanBGC.yml
---
documentation:
  description: |
    Recipe to evaluate the marine biogeochemistry models of CMIP5.
    There are also some physical evaluation metrics here too.
    This work based on the BGC-val toolkit GMD-2018-103.
    DOI: https://doi.org/10.5194/gmd-11-4215-2018
    Written by Lee de Mora, Plymouth Marine Laboratory, ledm@pml.ac.uk

  authors:
    - ledm

  references:
    - "de Mora, L., Yool, A., Palmieri, J., Sellar, A., Kuhlbrodt, T., Popova,
      E., Jones, C., and Allen, J. I.: BGC-val: a model- and grid-independent
      Python toolkit to evaluate marine biogeochemical models,
      Geosci. Model Dev., 11, 4215-4240, https://doi.org/10.5194/gmd-11-4215-2018,
      2018."

  projects:
    - ukesm


datasets:
# working datasets
  # - {dataset: CanESM2,       project: CMIP5,  exp: historical,  ensemble: r1i1p1,  start_year: 2001,  end_year: 2004}
  # - {dataset: CanCM4,    project: CMIP5,   exp: historical,  ensemble: r1i1p1,  start_year: 2001,  end_year: 2004}
  # - {dataset: CSIRO-Mk3-6-0,    project: CMIP5,  exp: historical,  ensemble: r1i1p1,  start_year: 2001,  end_year: 2004}
  # - {dataset: GISS-E2-H,    project: CMIP5,   exp: historical,  ensemble: r1i1p1,  start_year: 2001,  end_year: 2004}
  # - {dataset: HadGEM2-AO,    project: CMIP5,   exp: historical,  ensemble: r1i1p1,  start_year: 2001,  end_year: 2004}
  - {dataset: HadGEM2-CC,    project: CMIP5,  exp: historical,  ensemble: r1i1p1,  start_year: 2001,  end_year: 2004}
  - {dataset: HadGEM2-ES,    project: CMIP5,  exp: historical,  ensemble: r1i1p1,  start_year: 2001,  end_year: 2004}
  # - {dataset: HadCM3,    project: CMIP5,    exp: historical,  ensemble: r1i1p1,  start_year: 2001,  end_year: 2004}




###
# Problem with times
#  - {dataset: MIROC-ESM,    project: CMIP5,  mip: Oyr,  exp: historical,  ensemble: r1i1p1,  start_year: 2001,  end_year: 2004}
#  - {dataset: MIROC-ESM-CHEM,    project: CMIP5,  mip: Oyr,  exp: historical,  ensemble: r1i1p1,  start_year: 2001,  end_year: 2004}

# Unstructured grids
#  - {dataset: MPI-ESM-LR,  project: CMIP5,  mip: Oyr,  exp: historical,  ensemble: r1i1p1,  start_year: 2001,  end_year: 2003}
#  - {dataset: MPI-ESM-MR,  project: CMIP5,  mip: Oyr,  exp: historical,  ensemble: r1i1p1,  start_year: 2001,  end_year: 2004}
#  - {dataset: ACCESS1-0,    project: CMIP5,  mip: Oyr,  exp: historical,  ensemble: r1i1p1,  start_year: 2001,  end_year: 2004}
#  - {dataset: ACCESS1-3,    project: CMIP5,  mip: Oyr,  exp: historical,  ensemble: r1i1p1,  start_year: 2001,  end_year: 2004}


# --------------------------------------------------
# Preprocessors
# --------------------------------------------------
preprocessors:
  # Global 3D Volume-weighted Average
  prep_timeseries_global_volume_average:
    custom_order: true
    average_volume:
      coord1: longitude
      coord2: latitude
      coordz: depth
    multi_model_statistics:
      span: overlap
      statistics: [mean ]

  # Global area-weighted Average from 2D field
  prep_global_Surface_average_timeseries_2D:
    custom_order: true
    average_region:
      coord1: longitude
      coord2: latitude
    multi_model_statistics:
      span: overlap
      statistics: [mean ]

  # Global area -weighted surface Average from 3D field
  prep_global_Surface_average_timeseries_3D:
    custom_order: true
    extract_levels:
      levels:  [0., ]
      scheme: linear_horizontal_extrapolate_vertical
    average_region:
      coord1: longitude
      coord2: latitude
    multi_model_statistics:
      span: overlap
      statistics: [mean ]

  # For a 2D global surface map
  prep_surface_map_2D:
    time_average:

  # For a 3D global surface map
  prep_surface_map_3D:
    extract_levels:
      levels:  [0., ]
      scheme: linear_horizontal_extrapolate_vertical
    time_average:

  # 2D map global depth integration
  prep_depth_integration:
    depth_integration:
      coordz: depth
#      new_units: kg m-2 # need to specify in advance, as cf_units has strange behaviour.
    time_average:

  # 2D map global depth integration time series maps
  prep_depth_integration_timeseries:
    custom_order: true
    depth_integration:
      coordz: depth
    average_region:
      coord1: longitude
      coord2: latitude



# --------------------------------------------------
# Diagnostics
# --------------------------------------------------
diagnostics:
# Need to add:
# Add
# Global net integrated primary production map/timeseries
# Global surface mean chlorophyll map/timeseries
# Global surface mean nutrients map/timeseries
# Global volume average Temperature
# Global Air sea flux of CO2
# Global volumne average salinity
# Drake passge/AMOC (if exists as scalar field)
      #

  # --------------------------------------------------
  # Time series
  # --------------------------------------------------
  diag_timeseries_volume_average:
    description: Global volume average time series
    variables:
      thetao: # Temperature 3D
        preprocessor: prep_timeseries_global_volume_average
        field: TO3M
        mip: Omon
      so: # Salinity 3D
        preprocessor: prep_timeseries_global_volume_average
        field: TO3M
        mip: Omon
      dic: # Dissolved inorganic carbon
        preprocessor: prep_timeseries_global_volume_average
        field: TO3Y
        mip: Oyr
      alk: # alkalinity
        preprocessor: prep_timeseries_global_volume_average
        field: TO3Y
        mip: Oyr
      dfe: # iron
        preprocessor: prep_timeseries_global_volume_average
        field: TO3Y
        mip: Oyr
      po4: # phosphate
        preprocessor: prep_timeseries_global_volume_average
        field: TO3Y
        mip: Oyr
      no3: # nitrate
        preprocessor: prep_timeseries_global_volume_average
        field: TO3Y
        mip: Oyr
      o2: # oxygen
        preprocessor: prep_timeseries_global_volume_average
        field: TO3Y
        mip: Oyr
    scripts:
      Global_VolumeAverage_timeseries:
        script: ocean/diagnostic_timeseries.py

  diag_timeseries:
    description: Global surface time series
    variables:
      tos: # Temperature ocean surface
        preprocessor: prep_global_Surface_average_timeseries_2D
        field: TO2M
        mip: Omon
      sos: # Salinity ocean surface
        preprocessor: prep_global_Surface_average_timeseries_2D
        field: TO2M
        mip: Omon
      chl: # chlorophyll ocean surface
        preprocessor: prep_global_Surface_average_timeseries_3D
        field: TO3Y
        mip: Oyr
      intpp:
         preprocessor: prep_global_Surface_average_timeseries_2D
         field: TO2M
         mip: Omon
      no3: # Nitrate ocean surface
        preprocessor: prep_global_Surface_average_timeseries_3D
        field: TO3Y
        mip: Oyr
      po4: # Phosphate
        preprocessor: prep_global_Surface_average_timeseries_3D
        field: TO3Y
        mip: Oyr
      dfe: # iron
        preprocessor: prep_global_Surface_average_timeseries_3D
        field: TO3Y
        mip: Oyr
      si: Silicate
        preprocessor: prep_global_Surface_average_timeseries_3D
        field: TO3Y
        mip: Oyr
      dic: # Dissolved inorganic carbon ocean surface
        preprocessor: prep_global_Surface_average_timeseries_3D
        field: TO3Y
        mip: Oyr
      alk: #alkalinity ocean surface
        preprocessor: prep_global_Surface_average_timeseries_3D
        field: TO3Y
        mip: Oyr
    scripts:
      Global_VolumeAverage_timeseries:
        script: ocean/diagnostic_timeseries.py


  # --------------------------------------------------
  # Map diagnostics
  # --------------------------------------------------
  diag_maps:
    description: Global Ocean Surface mean timeseries
    variables:
      tos:
        preprocessor: prep_surface_map_2D
        field: TO2M
        mip: Omon
      sos:
        preprocessor: prep_surface_map_2D
        field: TO2M
        mip: Omon
      intpp:
         preprocessor: prep_surface_map_2D
         field: TO2M
         mip: Omon
      chl:
        preprocessor: prep_surface_map_3D
        field: TO3Y
        mip: Oyr
        thresholds: [0.1, 0.2, 0.5]
      no3:
        preprocessor: prep_surface_map_3D
        field: TO3Y
        mip: Oyr
      si: Silicate
        preprocessor: prep_surface_map_3D
        field: TO3Y
        mip: Oyr
      po4:
        preprocessor: prep_surface_map_3D
        field: TO3Y
        mip: Oyr
      dfe:
        preprocessor: prep_surface_map_3D
        field: TO3Y
        mip: Oyr
      dic:
        preprocessor: prep_surface_map_3D
        field: TO3Y
        mip: Oyr
    scripts:
      Global_Ocean_surface_map:
        script: ocean/diagnostic_maps.py

  # # Depth integrated maps
  # diag_depth_int_maps:
  #   description: Global Ocean Depth Integrated maps
  #   variables:
  #     chl:
  #       preprocessor: prep_depth_integration
  #       field: TO3Y
  #       mip: Oyr
  #     # intpp:
  #     #   preprocessor: prep_depth_integration
  #     #   field: TO3Y
  #     #   mip: Oyr
  #   scripts:
  #     Global_Ocean_DepthIntegration_map:
  #       script: ocean/diagnostic_maps.py

  diag_depth_int_timeseries:
    description: Global Ocean Depth Integrated time series
    variables:
      chl:
        preprocessor: prep_depth_integration_timeseries
        field: TO3Y
        mip: Oyr
      # intpp:
      #   preprocessor: prep_depth_integration_timeseries
      #   field: TO3Y
      #   mip: Oyr
    scripts:
      Global_Ocean_DepthIntegration_timeseries:
        script: ocean/diagnostic_timeseries.py
        flags: area_total
